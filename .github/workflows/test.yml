name: Automated Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level for tests'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR

env:
  PYTHON_VERSION: '3.12'
  UV_VERSION: '0.4.0'

jobs:
  # Job 1: Unit and Integration Tests with Full Service Stack
  test:
    name: Run Tests with Services
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Service containers for testing
    services:
      # MySQL for main database
      mysql:
        image: mysql:8.3
        env:
          MYSQL_ROOT_PASSWORD: test_root_password
          MYSQL_DATABASE: yggdrasil_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      
      # Redis for caching and Celery
      redis:
        image: redis:8-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-server --version"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ÔøΩ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client redis-tools
          echo "‚úÖ System dependencies installed"

      - name: ÔøΩüì¶ Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: false  # Disable cache to avoid 400 errors

      - name: üîß Install dependencies
        run: |
          uv sync --extra test
          echo "‚úÖ Dependencies installed"

      - name: üóÑÔ∏è Wait for services to be ready
        run: |
          echo "‚è≥ Waiting for services to be healthy..."
          
          # Wait longer for all services to be ready
          for i in {1..30}; do
            echo "Attempt $i/30..."
            
            # Check MySQL
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ptest_root_password --silent 2>/dev/null; then
              echo "‚úÖ MySQL is ready"
              MYSQL_READY=1
            fi
            
            # Check Redis
            if redis-cli -h 127.0.0.1 -p 6379 ping 2>/dev/null | grep -q PONG; then
              echo "‚úÖ Redis is ready"
              REDIS_READY=1
            fi
            
            # All services ready?
            if [ "$MYSQL_READY" = "1" ] && [ "$REDIS_READY" = "1" ]; then
              echo "‚úÖ All services are ready!"
              exit 0
            fi
            
            sleep 2
          done
          
          echo "‚ùå Timeout waiting for services"
          exit 1

      - name: üîê Create test environment file
        run: |
          cat << EOF > .env
          # Database Configuration
          MYSQL_HOST=127.0.0.1
          MYSQL_PORT=3306
          MYSQL_DATABASE=opentaberna_test
          MYSQL_USER=test_user
          MYSQL_PASSWORD=test_password
          
          # Redis Configuration
          REDIS_URL=redis://127.0.0.1:6379/0
          
          # Keycloak Configuration (from secrets)
          KEYCLOAK_URL=${{ secrets.TEST_KEYCLOAK_URL }}
          REALM=${{ secrets.TEST_REALM }}
          CLIENT_ID=${{ secrets.TEST_CLIENT_ID }}
          CLIENT_SECRET=${{ secrets.TEST_CLIENT_SECRET }}
          
          # Logging
          LOG_LEVEL=${{ github.event.inputs.log_level || 'INFO' }}
          EOF
          
          echo "‚úÖ Test environment file created"

      - name: üóÑÔ∏è Initialize databases
        run: |
          echo "üîß Setting up test databases..."
          
          # Create tables in main database if needed
          mysql -h 127.0.0.1 -P 3306 -u test_user -ptest_password yggdrasil_test -e "SHOW TABLES;" || true
          
          echo "‚úÖ Databases initialized"

      - name: üß™ Run unit tests
        run: |
          source .venv/bin/activate
          echo "üß™ Running unit tests..."
          pytest tests/ -v --tb=short --color=yes -m "not integration and not slow"
          echo "‚úÖ Unit tests completed"

      - name: üîó Run integration tests
        run: |
          source .venv/bin/activate
          echo "üîó Running integration tests..."
          pytest tests/ -v --tb=short --color=yes -m "integration"
          echo "‚úÖ Integration tests completed"
        continue-on-error: true

      - name: üìä Generate coverage report
        if: always()
        run: |
          source .venv/bin/activate
          echo "üìä Generating coverage report..."
          pytest tests/ \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=test-results.xml
          echo "‚úÖ Coverage report generated"

      - name: üìà Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: üì¶ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.xml
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: üìä Test Summary
        if: always()
        run: |
          echo "## üß™ Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test-results.xml ]; then
            echo "‚úÖ Test results generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f coverage.xml ]; then
            echo "‚úÖ Coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Test results (JUnit XML)" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage report (XML & HTML)" >> $GITHUB_STEP_SUMMARY

  # Job 2: Lint and Code Quality
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test]
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: false  # Disable cache to avoid 400 errors

      - name: üîß Install dependencies
        run: |
          uv sync --extra dev

      - name: üîç Run Ruff linting
        run: |
          source .venv/bin/activate
          echo "üîç Running Ruff linter..."
          ruff check src/ tests/ --output-format=github
        continue-on-error: true

      - name: üé® Run Ruff formatting check
        run: |
          source .venv/bin/activate
          echo "üé® Checking code formatting..."
          ruff format --check src/ tests/
        continue-on-error: true

      - name: üìù Lint Summary
        run: |
          echo "## üîç Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Linting completed" >> $GITHUB_STEP_SUMMARY

  # Job 3: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test]
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ÔøΩ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: false

      - name: üîß Install Bandit
        run: |
          uv pip install --system bandit[toml]
          echo "‚úÖ Bandit installed"

      - name: üîç Run Bandit security code analysis
        run: |
          echo "üîç Running Bandit security analysis..."
          bandit -r src/ -f json -o bandit-results.json || true
          bandit -r src/ -f txt -o bandit-results.txt || true
          bandit -r src/ -f screen
          echo "‚úÖ Bandit scan completed"
        continue-on-error: true

      - name: üìä Display Bandit results in summary
        if: always()
        run: |
          echo "## üîç Bandit Code Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f bandit-results.txt ]; then
            echo "### üêç Python Code Security Issues:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat bandit-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Extract severity counts from JSON if available
            if [ -f bandit-results.json ]; then
              HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-results.json 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-results.json 2>/dev/null || echo "0")
              LOW=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' bandit-results.json 2>/dev/null || echo "0")
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### üìà Severity Breakdown:" >> $GITHUB_STEP_SUMMARY
              echo "- üî¥ High: $HIGH" >> $GITHUB_STEP_SUMMARY
              echo "- üü° Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
              echo "- üü¢ Low: $LOW" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ÔøΩüîí Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'
          # Scan Python dependencies and filesystem
          scanners: 'vuln,secret,config'
        continue-on-error: true

      - name: üìä Generate detailed Trivy report
        if: always()
        run: |
          # Install trivy if not available
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y
          
          # Run detailed scan
          trivy fs --severity CRITICAL,HIGH,MEDIUM --format json --output trivy-results.json .
          trivy fs --severity CRITICAL,HIGH,MEDIUM --format table --output trivy-results.txt .
          
          echo "‚úÖ Detailed scan completed"

      - name: ÔøΩ Display scan results in summary
        if: always()
        run: |
          echo "## üîí Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f trivy-results.txt ]; then
            echo "### üìä Vulnerabilities Found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 100 trivy-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Count vulnerabilities
            CRITICAL=$(grep -c "CRITICAL" trivy-results.txt || echo "0")
            HIGH=$(grep -c "HIGH" trivy-results.txt || echo "0")
            MEDIUM=$(grep -c "MEDIUM" trivy-results.txt || echo "0")
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìà Summary:" >> $GITHUB_STEP_SUMMARY
            echo "- üî¥ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- üü† High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- üü° Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Full results available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ÑπÔ∏è **Note:** GitHub Code Scanning (Advanced Security) is not enabled." >> $GITHUB_STEP_SUMMARY
          echo "This means results won't appear in the Security tab, but are available in:" >> $GITHUB_STEP_SUMMARY
          echo "- This workflow summary (above)" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts (downloadable JSON/TXT reports)" >> $GITHUB_STEP_SUMMARY

      - name: üì¶ Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            bandit-results.json
            bandit-results.txt
            trivy-results.json
            trivy-results.txt
          retention-days: 30
        continue-on-error: true

  # Job 4: Build Docker Image (without pushing)
  build-test:
    name: Test Docker Build
    runs-on: ubuntu-latest
    needs: [test]
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./src/Dockerfile
          push: false
          tags: opentaberna-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üèóÔ∏è Build Summary
        run: |
          echo "## üê≥ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Docker image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "üè∑Ô∏è Tag: opentaberna-api:test" >> $GITHUB_STEP_SUMMARY

  # Job 5: Test Summary Report
  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [test, lint, security, build-test]
    if: always()
    
    steps:
      - name: üìä Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
        continue-on-error: true

      - name: üìã Generate final report
        run: |
          echo "# üéâ Test Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Docker Build: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "- MySQL 8.3 ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- Redis 8 ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ready for deployment! üöÄ" >> $GITHUB_STEP_SUMMARY
